---
authors: Alexander Klizhentas (sasha@gravitational.com), Brian Joerger (bjoerger@gravitational.com)
state: draft
---

# RFD 10 - API and Client Libraries

## What

- Unify Golang Client experience.
- Automatically generate API documentation using [pkg.go.dev](https://pkg.go.dev/).

## Why

There are several problems with the Teleport Go client libraries:

* The [Go client example](https://github.com/gravitational/teleport/tree/branch/5.0/examples/go-client) uses the teleport Go module as a dependency. This means that the example pulls in all of the teleport module's packages and indirect dependencies, leading to extreme import bloat.
* There is no separate client library with guarantees of compatibility with specific version of Teleport. See examples [here](https://github.com/kubernetes/client-go#compatibility-matrix).
* Some client logic is residing in [plugins](https://github.com/gravitational/teleport-plugins/blob/master/access/access.go), while other logic is in `teleport/lib` packages.
* It's impossible to generate the library in any other language other than Go due to an unclear API surface.
* Code in `lib/auth` uses some concepts unfamiliar to Go users. For example, it deals with tls certificates at a low level:

```go
// connectClient establishes a gRPC connection to an auth server.
func connectClient() (*auth.Client, error) {
    tlsConfig, err := LoadTLSConfig("certs/api-admin.crt", "certs/api-admin.key", "certs/api-admin.cas")
    if err != nil {
        return nil, fmt.Errorf("Failed to setup TLS config: %v", err)
    }

    // must parse addr list panics and is not necessary
    authServerAddr := utils.MustParseAddrList("127.0.0.1:3025")
    clientConfig := auth.ClientConfig{Addrs: authServerAddr, TLS: tlsConfig}

    // TLS client is the only client
    return auth.NewTLSClient(clientConfig)
}
```

## Details

A new `api` Go module will be made to expose existing and new API features. It will be a submodule of `teleport`, so it will be impossible to have `teleport` as a dependency. This will make it easy to import the API with a small import footprint. Users will be able to run `go get github.com/gravitational/teleport/api` to get the latest version of the API and get started.

Teleport's interal gRPC Auth client will be moved into the `api/client` package and embedded in the old client for backwards compatibility. Over time, the internal client will be deprecated and replaced with the new public client.

Other logic such as the web client and tls/ssh certificate logic will be moved to the `api` package as well.

The new client will gain several new quality of life improvements, including credential loaders, automatic server version checking, better documentation, and more language implementations.

### Make independent api package

Move the API client and its dependencies to the new `api` package to keep Teleport's API layer unified.

`api` package file structure:
```
teleport/ 
└── api/
    ├── client
    |   ├── proto
    │   |   ├── authservice.proto
    │   |   └── authservice.pb.go
    │   ├── client.go
    |   └── webclient
    |       └── webclient.go
    ├── types
    │   ├── events
    │   |   ├──events.proto
    │   |   └──events.pb.go
    │   ├── wrappers
    │   |   ├──wrappers.proto
    │   |   └──wrappers.pb.go
    │   ├── types.proto
    |   └── types.pb.go
    ├── go.mod
    ├── go.sum
    ... utils, defaults, constants, and other limited api dependencies
```

#### Backwards compatibility

Use Go's type aliases to refactor code into the `api` package while maintaining backwards compatibility in the main `teleport` package. These aliases will be removed after one major version (`v7.0.0`).

```go
// Preserve full backwards compatibility
type services.Role = types.Role
type auth.Service = proto.Service
```

#### Separating the API from `teleport` packages

Since `api` will be a submodule and depenency of `teleport`, it will cause an import cycle if `api` has any dependencies on `teleport`. However, `teleport` packages are all dependent on each other in a convoluted dependency graph, so one of the challenges of moving the API to its own module will be to sort out these dependencies.

The majority of code that needs to be moved to the `api` module is in `teleport/lib/auth/clt.go` and `teleport/lib/services`. The former will be largely extracted into `api/client` and the latter into `api/types`.

Any protobuf generated code relevant to the API, including `teleport/lib/events` and `teleport/lib/wrappers`, should be moved into `api`.

Code in some other package, such as `lib/constants`, `lib/defaults`, `lib/utils`, `teleport/lib/events` and `teleport/lib/wrappers`, will need to be extracted into to `api` module as well.

##### Track dependencies

Some logic found in these package will be beyond the scope of the external API and should be refactored to minimize dependencies and reduce the number indirect imports for API users. This will help to clarify the separation between api and business logic and make the client more language agnostic.

For example, in `lib/services/role`, `role.CheckAndSetDefaults` has some business logic that should remain on the server side. Therefore that logic should be extracted into a new function, `ValidateRole`, and kept in `lib/services/role.go` rather than `api/types/role.go`.

```go
// api/types/role.go
(r *RoleV3) CheckAndSetDefaults() error {
  ... basic validation with business logic extracted
}
```

```go
// lib/services/role.go
func ValidateRole(r types.Role) error {
  ... business logic
}
```

Some basic dependencies will be unavoidable:
  * `gravitational/trace`
  * `google.golang.org/grpc`
  * `golang.org/x/net`
  * `golang.org/x/crypto`
  * `github.com/stretchr/testify`

If the list of dependencies grows beyond 20 dependencies and indirect dependencies, this issue should be revisited for better tracking mechanisms.

##### Deprecate the `lib/auth.Client`

As stated before, all gRPC client related code will be moved out of `teleport/lib/auth/clt.go` and into `api/client`. Backwards compatibility will be maintained by embedding the gRPC `api/client.Client` in the internal `teleport/lib/auth.Client`.

Additionally, the remaining HTTP endpoints in the internal client will be converted and added to the gRPC client. To maintain backwards compatibility with old servers, the internal client will be updated to first try the new gRPC endpoint before falling back to the existing HTTP endpoint. These fallback methods will be moved to `teleport/lib/auth/httpfallback.go` and deprecated after one major release cycle.

There is [issue](https://github.com/gravitational/teleport/issues/6394) used to track remaining endpoints that need to be converted to gRPC. 

Once all necessary endpoints have been added in gRPC and all HTTP fallback logic has been deprecated and removed, the gRPC client can completely replace the existing `lib/auth.Client`. At this point the underlying gRPC server will be the same, so the transition should be relatviley straightforward.

### api module

The api package will be made a sub module of teleport. It will exist in the `teleport/api`, and will be imported by the main `teleport` module through a go.mod [replace directive](https://golang.org/ref/mod#go-mod-file-replace) using a relative path.

Users will be able to get the latest api version by using `go get github.com/gravitational/teleport/api`, or a specific version with `go get github.com/gravitational/teleport/api@vX.Y.Z`.

#### versioning

Go module versioning must follow semver. Since [Teleport versioning](https://github.com/gravitational/teleport/blob/master/rfd/0012-teleport-versioning.md) is a subset of semver, the API can easily follow both version requirements by matching the Teleport version. This means that when `v7.0.1` of Teleport is released, `v7.0.1` of the API will also be released.

Go module versions can automatically be pushed with git tags. Since the api module is a sub module, its version tags will look like `git tag api/vX.Y.Z`. The version can be tagged as part of the release process just like the teleport repository.

Since Teleport has a major version above 2, the api must follow the [v2+ Go Module release guide](https://github.com/golang/go/wiki/Modules#releasing-modules-v2-or-higher) by appending a major version suffix to the import path. The import path for each major version `X` will look like `github.com/gravitational/teleport/api/vX`.

This import path needs to be updated within the entire teleport repository. This can be done before each major release. This import path change is likely to cause minor merge conflicts in backport PRs that are a full major version back.

Additionally, if the git tag and import suffix aren't set up, the api will be versioned as v0.0.0-[random-string]. Getting the latest version with `go get github.com/gravitational/teleport/api` will get the most recent version in terms of time rather than semver/teleport version, confusing and not user friendly. For this reason it's important to start tagging the version and add the `vX` suffix as soon as possible.

### Client experience improvements

This is a list of quality of life improvments that will be added to the new api client. 

#### Go native user experience

The client user experience will be simplified with a new client constructor. The client constructor should be able to retrieve credentials during initialization and handle errors. It should also transparently handle dialing via a proxy if a proxy address or tunnel dialer is provided (along with valid ssh credentials).

```go
import (
   "github.com/gravitational/teleport/api/client"
)

func main() {
  // TLS client is the only TLS client supported in teleport
  client, err := client.New(client.Config{
    Addrs: []string{"localhost:3025"},
    // ContextDialer is an optional context dialer
    ContextDialer: net.DialContext,
    // direct TLS credentials config
    Credentials: []client.Credentials{
      client.TLSCreds(tls.Config),
    }
  })
  ...
  defer client.Close()

  ping, err := client.Ping()
  ...
  fmt.Printf("Ping: %v\n", ping.Version)
}
```

```bash
$ go mod init
$ go run main.go
```

#### Credential providers

Support multiple credential providers:
  * `client.LoadTLS(*tls.Config)` loads creds from TLS config.
  * `client.LoadKeyPair("crt_path", "key_path", "cas_path")` loads creds from tls certificates.
  * `client.LoadProfile("profile_path", "profile_name")` loads creds from the users default or specified tsh profile.
  * `client.LoadIdentityFile("identity_file_path")` loads creds from an identity file.

Support tunnel address discovery from the web proxy, as well as tunnel proxy connectivity using ssh certificates. Since tsh profiles have ssh certificates and the web proxy address, LoadProfile should be able to load the client without any user input. The user can simply `tsh login` and then the client will retrieve their credentials. This mirrors the functionality that `tctl` offers.

```go
// for testing, use client spec that loads tunnel dialer and certificates from profile
client, err := client.New(client.Config{
  Credentials: client.Credentials{
    client.LoadProfile("", ""),
  },
})
```

```bash
$ tsh login
# try client
$ go run main.go
```

#### Automatically reload credentials

Credential loaders should detect underlying file changes and automatically reload credentials and update the grpc transport.

#### Automatically check server version

The client automatically verify that its version is compatible with the server's version by calling `Ping` and during client initialization, similarly to how tsh does.

The client will fail to initialize if the the versions are not compatible. The user can override this by providing `SkipVersionCheck: true` in `client.Config` to avoid blocking users that are in the middle of upgrading.

### Move Access requests code into client

Move `access` workflows code into `client` subpackage with new name `workflows`:

https://github.com/gravitational/teleport-plugins/tree/master/access

Instead of a separate client, `workflows` becomes a subpackage of the api client:

```go
import (
   "github.com/gravitational/teleport/api/client"
   "github.com/gravitational/teleport/api/client/workflows"
)

func main() {
   client, err := client.New(...)
   watcher, err := workflows.NewWatcher(ctx, client, workflows.Watch{State: ...})
   ...
   defer watcher.Close()

```

#### Provide simplified high level access hooks

Access hooks are too low level, add simple handler similar to http server design
with a router:

```go

func myTeamRequest(ctx context.Context, req access.Request) (access.Request, error) {
  return req, trace.AccessDenied("access denied")
}


func main() {
router := access.Router()
  // handle access requests from my team only
  router.HandleFunc(router.Match{Traits: Trait("team", "myteam")}
  srv := access.Server{
     Client: clt,
     Handler: router,
  }
```


### Improve API documentation user experience

Code comments throughout the api package will be made thourough and user focused. There will be examples and in depth explanations of user facing functions as needed. As a result, the automatically generated [pkg.go.dev](https://pkg.go.dev/github.com/gravitational/teleport/api/client) will be the main source of documentation.

For documentation outside of the scope of code comments, the api [reference docs](https://goteleport.com/docs/ver/6.2/reference/api/) will be rewritten with a `Getting Started` and `Architecture` section, as well as many links that point back to the pkg.go.dev docs.

### Add Python Client

Once the protobuf schema has been detangled from the `teleport/lib` code, it should be easy to create a bare bones `python` version of the Auth client. Python will be the first langauge of many new client libary implementations.

```bash
ls github.com/gravitational/teleport
api/
python/

$ pip install teleport-client
```

```python
import teleport

client = teleport.client(addr=...)
client.tokens()
```

Port router code

```python
@access.handle(clt, path=access.trait("team")):
def handle(req):
   if req.user == "bob":
      raise access.Denied("access denied")
```

Update docs to include the `python` variant of the client as well.
